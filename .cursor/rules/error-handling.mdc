---
description:
globs:
alwaysApply: false
---
# Error Handling Rules

## ğŸ“š Reference Documentation

**å¿…ãš [docs/error-handling.md](mdc:docs/error-handling.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚** è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æˆ¦ç•¥ã€å®Ÿè£…ä¾‹ã€ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

## ğŸ¯ Core Principles

1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’æœ€å„ªå…ˆ** - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯åˆ†ã‹ã‚Šã‚„ã™ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
2. **é–‹ç™ºè€…ã«ã¯è©³ç´°æƒ…å ±** - Sentryã«å®Œå…¨ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’é€ä¿¡
3. **äºˆæœŸå¯èƒ½ã‚¨ãƒ©ãƒ¼ã¨äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ã‚’åŒºåˆ¥** - UserFacingErrorã‚’é©åˆ‡ã«ä½¿ç”¨

## ğŸ› ï¸ Implementation Guidelines

### tRPCãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã§ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

#### neverthrow Resultã®å¤‰æ›
```typescript
// âœ… Good: Helperé–¢æ•°ã‚’ä½¿ç”¨
import { handleResultError, fileOperationErrorMappings } from '../lib/errorHelpers';

procedure.mutation(async (ctx) => {
  const result = await service.someOperation(ctx.input);
  handleResultError(result, fileOperationErrorMappings);
  return true;
});

// âœ… Good: ã‚µã‚¤ãƒ¬ãƒ³ãƒˆå‡¦ç†ãŒå¿…è¦ãªå ´åˆ
import { handleResultErrorWithSilent } from '../lib/errorHelpers';

procedure.mutation(async () => {
  const result = await service.showDialog();
  const dialogResult = handleResultErrorWithSilent(result, ['canceled'], fileOperationErrorMappings);
  if (dialogResult !== null) {
    // æˆåŠŸæ™‚ã®å‡¦ç†
  }
  return true;
});
```

#### ç›´æ¥çš„ãªã‚¨ãƒ©ãƒ¼æŠ•ã’
```typescript
// âœ… Good: ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
import { UserFacingError, OperationFailedError } from '../lib/errors';

if (invalidInput) {
  throw new UserFacingError('å…¥åŠ›ãŒç„¡åŠ¹ã§ã™ã€‚æ­£ã—ã„å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
}

if (operationFailed) {
  throw new OperationFailedError('ãƒ‡ãƒ¼ã‚¿ä¿å­˜', 'å®¹é‡ä¸è¶³ã®ãŸã‚ä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
}

// âœ… Good: äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ï¼ˆãã®ã¾ã¾æŠ•ã’ã‚‹ï¼‰
throw new Error('Unexpected API response format');
```

### ã‚µãƒ¼ãƒ“ã‚¹å±¤ã§ã®neverthrowã®ä½¿ç”¨

```typescript
// âœ… Good: è©³ç´°ãªã‚¨ãƒ©ãƒ¼å‹ã‚’å®šç¾©
export const getFileData = async (filePath: string): Promise<Result<string, 'ENOENT' | 'PERMISSION_DENIED'>> => {
  try {
    const data = await fs.readFile(filePath);
    return ok(data.toString());
  } catch (error) {
    if (error.code === 'ENOENT') {
      return err('ENOENT' as const);
    }
    if (error.code === 'EACCES') {
      return err('PERMISSION_DENIED' as const);
    }
    // äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ã¯throw
    throw error;
  }
};
```

## ğŸš« Avoid These Patterns

```typescript
// âŒ Bad: æ±ç”¨çš„ãªErrorã‚’neverthrowã§è¿”ã™
return neverthrow.err(new Error('Something went wrong'));

// âŒ Bad: tRPCãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã§if (result.isErr()) throw result.error
if (result.isErr()) {
  throw result.error; // Helperé–¢æ•°ã‚’ä½¿ã†ã¹ã
}

// âŒ Bad: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æŠ€è¡“çš„è©³ç´°ã‚’è¡¨ç¤º
throw new UserFacingError(`Database error: ${error.stack}`);

// âŒ Bad: ã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼ã‚’UserFacingErrorã«ã™ã‚‹
throw new UserFacingError('Network timeout occurred');
```

## ğŸ“¦ Available Helper Functions

Reference [electron/lib/errorHelpers.ts](mdc:electron/lib/errorHelpers.ts) for:

- `handleResultError()` - Result â†’ UserFacingErrorå¤‰æ›
- `handleResultErrorWithSilent()` - ã‚µã‚¤ãƒ¬ãƒ³ãƒˆå‡¦ç†å¯¾å¿œç‰ˆ
- `fileOperationErrorMappings` - ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œç”¨ãƒãƒƒãƒ”ãƒ³ã‚°
- `photoOperationErrorMappings` - å†™çœŸæ“ä½œç”¨ãƒãƒƒãƒ”ãƒ³ã‚°
- `vrchatLogErrorMappings` - VRChatãƒ­ã‚°ç”¨ãƒãƒƒãƒ”ãƒ³ã‚°
- `databaseErrorMappings` - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œç”¨ãƒãƒƒãƒ”ãƒ³ã‚°

## ğŸ¯ Error Classes

Reference [electron/lib/errors.ts](mdc:electron/lib/errors.ts) for:

- `UserFacingError` - ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”¨ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹
- `OperationFailedError` - å…·ä½“çš„ãªæ“ä½œå¤±æ•—ç”¨ã‚¯ãƒ©ã‚¹

## ğŸ“‹ Quick Decision Guide

1. **tRPCãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£å†…** â†’ Helperé–¢æ•°ã¾ãŸã¯UserFacingErrorã‚’ä½¿ç”¨
2. **ã‚µãƒ¼ãƒ“ã‚¹å±¤** â†’ neverthrowã®Resultãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¶™ç¶šä½¿ç”¨
3. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¦‹ã›ãŸã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚‹** â†’ UserFacingError
4. **äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼** â†’ é€šå¸¸ã®Errorã‚’ãã®ã¾ã¾æŠ•ã’ã‚‹
5. **ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç­‰ã®æ­£å¸¸ãªã‚±ãƒ¼ã‚¹** â†’ handleResultErrorWithSilentã§ã‚µã‚¤ãƒ¬ãƒ³ãƒˆå‡¦ç†
